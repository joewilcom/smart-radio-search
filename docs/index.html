<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Radio Search</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 1rem;
      background-color: #B7B7B7;
      color: #111;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark {
      background-color: #121212;
      color: #eee;
    }
    input, button, select {
      padding: 0.5rem;
      font-size: 1rem;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    .station {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dark .station {
      background: #1e1e1e;
    }
    .loading {
      font-style: italic;
    }
    .tag {
      display: inline-block;
      background: #ddd;
      border-radius: 4px;
      padding: 2px 6px;
      margin: 2px;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .dark .tag {
      background: #444;
      color: #eee;
    }
  </style>
<script src="twemoji.min.js"></script>
</head>
<body>
  <h2>Smart Radio Search v1.1</h2>
  <div class="controls">
    <input id="query" placeholder="Search for genre, location, etc..." />
    <select id="sortBy">
      <option value="votes" selected>Votes</option>
      <option value="clickcount">Clicks</option>
      <option value="bitrate">Bitrate</option>
    </select>
    <button onclick="search()">Search</button>
    <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
  </div>
  <div id="results"><p class="loading">Loading top stations...</p></div>

  <script>
    let playingAudio = null;

    function flagEmoji(code) {
      if (!code) return '';
      return String.fromCodePoint(...[...code.toUpperCase()].map(c => 127397 + c.charCodeAt(0)));
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
    }

    function renderStations(stations, label = '') {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = '';
      if (label) {
        const heading = document.createElement('h3');
        heading.textContent = label;
        resultsDiv.appendChild(heading);
      }

      const grid = document.createElement('div');
      grid.className = 'grid';

      stations.forEach((station, index) => {
        const div = document.createElement("div");
        div.className = "station";
        let tags = station.tags?.split(',') || [];
        const tagList = tags.slice(0, 5).map(tag => `<span class="tag" onclick="searchTag('${tag.trim()}')">${tag.trim()}</span>`).join(' ');
        const truncated = tags.length > 5 ? ' <span class="tag">...</span>' : '';

        div.innerHTML = `
          <strong>${label && index < 10 ? `#${index + 1} ` : ''}${station.name}</strong><br>
          <em>${station.country || ''} ${flagEmoji(station.countrycode)}</em><br>
          <div>${tagList}${truncated}</div>
          <p><strong>Bitrate:</strong> ${station.bitrate || '?'} kbps |
             <strong>Codec:</strong> ${station.codec || '?'} |
             <strong>Clicks:</strong> ${station.clickcount} |
             <strong>Votes:</strong> ${station.votes}</p>
          <audio controls preload="none" onplay="pauseOthers(this)">
            <source src="${station.url_resolved}" type="audio/mpeg">
            Your browser does not support the audio element.
          </audio><br>
          <a href="${station.url}" target="_blank">Listen</a>
        `;
        grid.appendChild(div);
      });

      resultsDiv.appendChild(grid);
      twemoji.parse(resultsDiv);
    }

    function pauseOthers(current) {
      if (playingAudio && playingAudio !== current) {
        playingAudio.pause();
      }
      playingAudio = current;
    }

    function searchTag(tag) {
      document.getElementById("query").value = tag;
      search();
    }

    async function search() {
  const query = document.getElementById("query").value.trim();
  const sortBy = document.getElementById("sortBy").value || "votes";
  if (!query) return;
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "<p class='loading'>Thinking...</p>";

  let refinedTags = "";
  try {
    const aiRes = await fetch("https://simple-naomi-joewilcom-71ae2211.koyeb.app/ai-query", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query })
    });
    const aiJson = await aiRes.json();
	console.log("AI response:", aiJson);
    if (aiJson.tags) {
      refinedTags = aiJson.tags;
    }
  } catch (err) {
    console.warn("AI query fallback", err);
  }

  const finalQuery = refinedTags || query;
  const field = refinedTags ? "tag" : "name";

  const response = await fetch("https://simple-naomi-joewilcom-71ae2211.koyeb.app/search", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      query: finalQuery,
      filter_dead: true,
      sort_by: sortBy,
      field
    })
  });

  const stations = await response.json();
  renderStations(stations);
}


    async function loadTopStations() {
      const response = await fetch("https://simple-naomi-joewilcom-71ae2211.koyeb.app/search", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: "", top: true, filter_dead: true, sort_by: "votes" })
      });
      const stations = await response.json();
      renderStations(stations, "Top 10 Streaming Stations");
    }

    // Run top stations on page load
    loadTopStations();

    // Trigger search on Enter key
    document.getElementById("query").addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        search();
      }
    });
	console.log("Final query:", finalQuery, "Field:", field);
  </script>
</body>
</html>
