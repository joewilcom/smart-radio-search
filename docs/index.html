<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Radio Search</title>

  <style>
    /* -------------------
       Global resets & vars
       ------------------- */
    :root {
      --bg: #b7b7b7;
      --fg: #111;
      --card-bg: #fff;
      --link: #0366d6;
    }
    [data-theme="dark"] {
      --bg: #222;
      --fg: #eee;
      --card-bg: #333;
      --link: #58a6ff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.5;
    }

    /*  Header & controls  */
    header {
      padding: 1rem;
    }
    header h1 {
      font-size: 2rem;
      margin-bottom: 0.25rem;
    }
    header .description {
      margin-bottom: 1rem;
      font-size: 0.95rem;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .controls input,
    .controls select,
    .controls button {
      padding: 0.5rem 0.75rem;
      font-size: 0.95rem;
      border: 1px solid #aaa;
      border-radius: 4px;
    }
    .controls button {
      cursor: pointer;
    }

    /*  Stations grid  */
    #stations {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px,1fr));
      gap: 1rem;
      padding: 0 1rem 1rem;
    }

    /*  Individual “card”  */
    .station-card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    .station-card h2 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    /* flag + country line */
    .station-card .country {
      display: flex;
      align-items: center;
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
    }
    .station-card .country img.flag {
      width: 1em;
      height: auto;
      margin-right: 0.5em;
      display: inline-block;
    }

    /* audio player */
    .station-card audio {
      width: 100%;
      margin-bottom: 0.75rem;
    }

    /* stats & “now playing” */
    .station-card .stats {
      font-size: 0.9rem;
      line-height: 1.4;
      flex-grow: 1;
    }
    .station-card .stats em {
      display: block;
      margin-bottom: 0.5rem;
    }

    /* tags line */
    .station-card .tags {
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    .station-card .tags a {
      margin-right: 0.5em;
      color: var(--link);
      text-decoration: none;
    }
    .station-card .tags a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body data-theme="light">
  <header>
    <h1>Smart Radio Search</h1>
    <p class="description">
      Discover, preview, and play streaming radio stations from around the world —
      with AI-powered genre tagging, live filtering, and one-at-a-time playback.
    </p>

    <div class="controls">
      <input id="search-input" placeholder="Search for genre, location, etc." />
      <button id="search-button">Search</button>

      <select id="country-filter">
        <option value="">All Countries</option>
      </select>

      <select id="genre-filter">
        <option value="">All Genres</option>
      </select>

      <select id="sort-filter">
        <option value="votes">Votes ↓</option>
        <option value="clickcount">Clicks ↓</option>
        <option value="bitrate">Bitrate ↓</option>
      </select>

      <button id="toggle-dark">Toggle Dark Mode</button>
    </div>
  </header>

  <main>
    <div id="stations">
      <!-- station cards get injected here -->
    </div>
  </main>

  <script>
    (function(){
      const API_BASE = 'https://your-api-domain.com';  // ← adjust to your backend URL

      // UI refs
      const searchInput  = document.getElementById('search-input');
      const searchBtn    = document.getElementById('search-button');
      const countrySel   = document.getElementById('country-filter');
      const genreSel     = document.getElementById('genre-filter');
      const sortSel      = document.getElementById('sort-filter');
      const toggleDark   = document.getElementById('toggle-dark');
      const stationsDiv  = document.getElementById('stations');
      let currentAudio   = null;

      // attach events
      toggleDark.addEventListener('click', _=>{
        document.body.dataset.theme = document.body.dataset.theme === 'light' ? 'dark' : 'light';
      });
      searchBtn.addEventListener('click', runSearch);
      countrySel.addEventListener('change', runSearch);
      genreSel.addEventListener('change', runSearch);
      sortSel.addEventListener('change', runSearch);

      // on load: populate filters & show top
      window.addEventListener('DOMContentLoaded', async ()=>{
        await Promise.all([fetchCountries(), fetchGenres()]);
        loadTop();
      });

      // fetch country list
      async function fetchCountries(){
        try {
          let res = await fetch(API_BASE + '/countries');
          let list = await res.json();
          list.forEach(c => {
            let opt = document.createElement('option');
            opt.value = c.code;
            opt.textContent = c.code.toLowerCase() + ' ' + c.name;
            countrySel.append(opt);
          });
        } catch(e){
          console.warn('Country fetch failed',e);
        }
      }

      // common genres (top 20)
      const COMMON = [
        'pop','rock','jazz','classical','hip hop','electronic',
        'dance','country','blues','reggae','metal','folk',
        'soul','funk','disco','r&b','indie','alternative',
        'punk','latin'
      ];
      function fetchGenres(){
        COMMON.forEach(g=>{
          let o = document.createElement('option');
          o.value = g;
          o.textContent = g.charAt(0).toUpperCase() + g.slice(1);
          genreSel.append(o);
        });
      }

      // load “top stations” on page load
      async function loadTop(){
        fetchAndRender(API_BASE + '/top');
      }

      // runSearch triggered by any filter or input
      async function runSearch(){
        let name  = searchInput.value.trim();
        let code  = countrySel.value;
        let tag   = genreSel.value;
        let sort  = sortSel.value;
        let qs = new URLSearchParams();
        if(name) qs.set('name', name);
        if(tag)  qs.set('tag', tag);
        if(code) qs.set('country', code);
        qs.set('sort', sort);
        fetchAndRender(API_BASE + '/search?' + qs);
      }

      // fetch + render helper
      async function fetchAndRender(url){
        stationsDiv.innerHTML = 'Loading…';
        try {
          let res = await fetch(url);
          let data = await res.json();
          if(!data.length) {
            stationsDiv.innerHTML = '<p style="padding:1rem;">No stations found. Try a broader search.</p>';
            return;
          }
          stationsDiv.innerHTML = '';
          data.forEach(renderCard);
        } catch(e){
          console.error(e);
          stationsDiv.innerHTML = '<p style="padding:1rem;">Failed to load stations.</p>';
        }
      }

      // render one station
      function renderCard(st){
        let card = document.createElement('div');
        card.className = 'station-card';

        // title
        let h2 = document.createElement('h2');
        h2.textContent = `#${st.rank||''} ${st.name}`;
        card.append(h2);

        // country & flag
        let ctr = document.createElement('div');
        ctr.className = 'country';
        if(st.countrycode){
          let img = document.createElement('img');
          img.className = 'flag';
          img.src = `https://flagcdn.com/1x1/${st.countrycode.toLowerCase()}.svg`;
          img.onerror = _=>img.remove();
          ctr.append(img);
        }
        ctr.append(document.createTextNode(st.country || ''));
        card.append(ctr);

        // audio
        let audio = document.createElement('audio');
        audio.controls = true;
        audio.src = st.url_resolved || st.url;
        audio.addEventListener('play', ()=> {
          if(currentAudio && currentAudio !== audio) currentAudio.pause();
          currentAudio = audio;
        });
        card.append(audio);

        // stats
        let stat = document.createElement('div');
        stat.className = 'stats';
        stat.innerHTML = `
          <em>Now playing: —</em>
          Clicks: ${st.clickcount} | Votes: ${st.votes}<br>
          Bitrate: ${st.bitrate} kbps | Codec: ${st.codec}
        `;
        card.append(stat);

        // tags
        if(st.tags){
          let tg = document.createElement('div');
          tg.className = 'tags';
          tg.innerHTML = 'Tags: ' +
            st.tags.split(/,|\s+/).map(t=>t.trim()).filter(Boolean).slice(0,5)
              .map(t=>`<a href="#" data-tag="${t}">${t}</a>`).join(', ');
          // clicking a tag re-searches
          tg.querySelectorAll('a').forEach(a=>{
            a.addEventListener('click', e=>{
              e.preventDefault();
              genreSel.value = a.dataset.tag;
              runSearch();
            });
          });
          card.append(tg);
        }

        stationsDiv.append(card);
      }

    })();
  </script>
</body>
</html>
