<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Radio Search</title>
  <style>
    body { font-family: sans-serif; background: #ccc; color: #111; padding: 1rem; }
    .controls > * { margin-right: .5rem; }
    .station { background: #fff; padding: .75rem; margin: .5rem 0; border-radius: .5rem; }
    .station h2 { margin: 0 0 .5rem; }
    audio { width: 100%; margin: .5rem 0; }
  </style>
</head>
<body>
  <h1>Smart Radio Search</h1>
  <p>Discover, preview, and play streaming radio stations from around the world — with AI-powered genre tagging, live filtering, and one-at-a-time playback.</p>

  <div class="controls">
    <input id="searchInput" placeholder="Search for genre, location, etc." size="30"/>
    <button id="searchBtn">Search</button>
    <select id="countrySelect"><option>All Countries</option></select>
    <select id="genreSelect"><option>All Genres</option></select>
    <select id="sortSelect">
      <option value="votes">Votes ↓</option>
      <option value="clickcount">Clicks ↓</option>
      <option value="bitrate">Bitrate ↓</option>
    </select>
    <button id="darkToggle">Toggle Dark Mode</button>
  </div>

  <div id="stations"></div>

  <script>
    const API_BASE = "https://simple-naomi-joewilcom-71ae2211.koyeb.app";
    const COMMON_GENRES = [
      "pop","rock","jazz","classical","hip hop","electronic",
      "dance","country","blues","reggae","metal","folk",
      "soul","funk","disco","r&b","indie","alternative",
      "punk","latin"
    ];

    async function init(){
      populateGenres();
      await Promise.all([fetchCountries(), loadStations({top:true})]);
      document.getElementById("searchBtn").onclick = runSearch;
      document.getElementById("searchInput")
              .addEventListener("keypress", e=>{ if(e.key==="Enter") runSearch() });
      ["countrySelect","genreSelect","sortSelect"].forEach(id=>
        document.getElementById(id).onchange = runSearch
      );
    }

    function populateGenres(){
      let sel = document.getElementById("genreSelect");
      COMMON_GENRES.forEach(g=>{
        let o = document.createElement("option");
        o.value = g; o.textContent = g;
        sel.appendChild(o);
      });
    }

    async function fetchCountries(){
      try {
        let res = await fetch(`${API_BASE}/countries`);
        let list = await res.json();
        let sel = document.getElementById("countrySelect");
        list.forEach(c=>{
          let o = document.createElement("option");
          o.value = c.code;
          o.textContent = `${c.code} ${c.name}`;
          sel.appendChild(o);
        });
      }
      catch(e){ console.warn("Country fetch failed", e); }
    }

    async function loadStations(opts){
      const wrap = document.getElementById("stations");
      wrap.innerHTML = "<p>Loading…</p>";
      try {
        let res = await fetch(`${API_BASE}/search`, {
          method: "POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(opts)
        });
        let data = await res.json();
        renderStations(data);
      }
      catch(err){
        console.error(err);
        wrap.innerHTML = "<p>Failed to load stations.</p>";
      }
    }

    function runSearch(){
      const term = document.getElementById("searchInput").value.trim();
      const country = document.getElementById("countrySelect").value;
      const genre   = document.getElementById("genreSelect").value;
      if(!term && country==="All Countries" && genre==="All Genres"){
        return loadStations({top:true});
      }
      loadStations({
        top:false,
        name: term||undefined,
        countrycode: country!=="All Countries"?country:undefined,
        tagList: genre!=="All Genres"?genre:undefined
      });
    }

    function renderStations(arr){
      const wrap = document.getElementById("stations");
      wrap.innerHTML = "";
      if(!arr || arr.length===0){
        wrap.innerHTML = "<p>No stations found. Try a broader search.</p>";
        return;
      }
      // render each
      arr.forEach((s,i)=>{
        let div = document.createElement("div");
        div.className = "station";
        const tags = (s.tags||"")
                      .split(",")
                      .slice(0,5)
                      .map(t=>`<a href="#" onclick="searchTag('${t}')">${t}</a>`)
                      .join(", ")
                  + ((s.tags||"").split(",").length>5 ? " …" : "");
        div.innerHTML = `
          <h2>#${i+1} ${s.name}</h2>
          <p><span class="flag">${s.countrycode.toLowerCase()}</span> ${s.country}</p>
          <audio src="${s.url}" controls preload="none"></audio>
          <p><em>Now playing:</em> —</p>
          <p>Clicks: ${s.clickcount} | Votes: ${s.votes}</p>
          <p>Bitrate: ${s.bitrate} kbps | Codec: ${s.codec}</p>
          <p>Tags: ${tags || "—"}</p>
        `;
        wrap.appendChild(div);
      });
      // ensure only one plays at a time
      const audios = wrap.querySelectorAll("audio");
      audios.forEach(a=>
        a.addEventListener("play", ()=> audios.forEach(x=>{ if(x!==a) x.pause() }))
      );
    }

    function searchTag(t){
      document.getElementById("searchInput").value = t;
      runSearch();
    }

    window.onload = init;
  </script>
</body>
</html>
