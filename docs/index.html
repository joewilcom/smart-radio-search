<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Radio Search</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <h1>Smart Radio Search</h1>
    <p>Discover, preview, and play streaming radio stations from around the world — with AI-powered genre tagging, live filtering, and one-at-a-time playback.</p>
  </header>

  <section class="controls">
    <input id="searchInput" type="text" placeholder="Search for genre, location, etc." />
    <button id="searchBtn">Search</button>
    <select id="countryFilter">
      <option>All Countries</option>
    </select>
    <select id="genreFilter">
      <option>All Genres</option>
    </select>
    <select id="sortFilter">
      <option value="votes">Votes ↓</option>
      <option value="votes:asc">Votes ↑</option>
      <option value="clickcount">Clicks ↓</option>
      <option value="clickcount:asc">Clicks ↑</option>
    </select>
    <button id="darkModeToggle">Toggle Dark Mode</button>
  </section>

  <div id="aiTagsSection">
    <em id="aiTagsLabel"></em>
    <pre id="aiTagsRaw"></pre>
  </div>

  <div id="stations" class="grid"></div>

  <script>
    // --- CONFIG ---
    const API_BASE = 'https://simple-naomi-joewilcom-71ae2211.koyeb.app';
    const COMMON_GENRES = [
      "pop", "rock", "jazz", "classical", "hip hop",
      "electronic", "dance", "country", "blues", "reggae",
      "metal", "folk", "soul", "funk", "disco",
      "r&b", "indie", "alternative", "punk", "world"
    ];

    // --- STATE ---
    let currentStations = [];
    let currentAudio = null;

    // --- ELEMENTS ---
    const searchInput = document.getElementById('searchInput');
    const searchBtn   = document.getElementById('searchBtn');
    const countryFilter = document.getElementById('countryFilter');
    const genreFilter   = document.getElementById('genreFilter');
    const sortFilter    = document.getElementById('sortFilter');
    const stationsDiv   = document.getElementById('stations');
    const aiTagsLabel   = document.getElementById('aiTagsLabel');
    const aiTagsRaw     = document.getElementById('aiTagsRaw');

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
      populateGenreFilter();
      loadTopStations();
    });

    // --- POPULATE GENRE FILTER ---
    function populateGenreFilter() {
      COMMON_GENRES.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g;
        opt.textContent = capitalize(g);
        genreFilter.appendChild(opt);
      });
    }

    // --- LOAD TOP STATIONS ON PAGE LOAD ---
    async function loadTopStations() {
      try {
        const res = await fetch(`${API_BASE}/top`);
        const data = await res.json();
        currentStations = data;
        renderStations(data);
        populateCountryFilter(data);
      } catch (err) {
        stationsDiv.textContent = 'Failed to load top stations.';
      }
    }

    // --- POPULATE COUNTRY FILTER FROM STATION DATA ---
    function populateCountryFilter(stations) {
      const seen = new Map();
      stations.forEach(st => {
        const code = st.countrycode?.toLowerCase();
        const name = st.country;
        if (code && !seen.has(code)) {
          seen.set(code, name);
        }
      });
      // Add options
      seen.forEach((name, code) => {
        const opt = document.createElement('option');
        opt.value = code;
        opt.textContent = name;
        countryFilter.appendChild(opt);
      });
    }

    // --- SEARCH HANDLER ---
    searchBtn.addEventListener('click', search);
    searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') search(); });
    countryFilter.addEventListener('change', search);
    genreFilter.addEventListener('change', search);
    sortFilter.addEventListener('change', () => renderStations(currentStations));

    async function search() {
      const q = searchInput.value.trim();
      const country = countryFilter.value;
      const genre   = genreFilter.value;
      aiTagsLabel.textContent = '';
      aiTagsRaw.textContent   = '';
      try {
        // Get AI tags if query text
        let tags = [];
        if (q) {
          const aiRes = await fetch(`${API_BASE}/ai-query`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({query: q})
          });
          const aiJson = await aiRes.json();
          tags = aiJson.tags?.split(',').map(t=>t.trim().toLowerCase())||[];
          aiTagsLabel.innerHTML = `AI suggested tags: <strong>${tags.join(', ')}</strong>`;
          aiTagsRaw.textContent = JSON.stringify(aiJson, null, 2);
        }
        // Determine final search term
        let final = tags.length ? tags.join(',') : q;
        if (!final && genre !== 'All Genres') final = genre;
        if (!final && country !== 'All Countries') final = '';
        if (!final && genre==='All Genres' && country==='All Countries') {
          // Nothing to do
          return loadTopStations();
        }
        // Build URL
        const params = new URLSearchParams();
        if (final)       params.append('name', final);
        if (country!=='All Countries') params.append('countrycode', country);
        if (genre!=='All Genres')     params.append('tag', genre);
        const url = `${API_BASE}/search?${params.toString()}`;
        const res = await fetch(url);
        const data = await res.json();
        currentStations = data;
        renderStations(data);
      } catch (err) {
        stationsDiv.textContent = 'Search failed. Try again later.';
      }
    }

    // --- RENDER ---
    function renderStations(list) {
      // Sort
      const [field, dir] = sortFilter.value.split(':');
      list.sort((a,b) => dir==='asc'
        ? a[field] - b[field]
        : b[field] - a[field]
      );
      // Render
      stationsDiv.innerHTML = '';
      list.forEach((st,i) => {
        const card = document.createElement('article');
        card.className = 'station-card';
        card.innerHTML = `
        <h2>#${i+1} ${st.name}</h2>
        <p><span class="flag flag-${st.countrycode.toLowerCase()}"></span> ${st.country}</p>
        <audio controls data-src="${st.url_resolved}"></audio>
        <p class="meta">Now playing: <em>—</em></p>
        <ul>
          <li>Clicks: ${st.clickcount}</li>
          <li>Votes: ${st.votes}</li>
          <li>Bitrate: ${st.bitrate} kbps</li>
          <li>Codec: ${st.codec}</li>
          <li>Tags: ${st.tags || '—'}</li>
        </ul>
        `;
        stationsDiv.appendChild(card);

        // Playback logic
        const audio = card.querySelector('audio');
        audio.addEventListener('play', () => {
          if (currentAudio && currentAudio!==audio) {
            currentAudio.pause();
          }
          currentAudio = audio;
          card.querySelector('.meta em').textContent = st.name;
        });
      });
    }

    // --- UTIL ---
    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
  </script>
</body>
</html>