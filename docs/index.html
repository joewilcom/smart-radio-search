<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Smart Radio Search v1.2</title>
  <script src="twemoji.min.js"></script>
  <style>
    body {
      background-color: #B7B7B7;
      color: black;
      font-family: sans-serif;
      padding: 1rem;
    }
    .loading { font-style: italic; }
    #results > div { margin-bottom: 1.5rem; }
    input, select, button { margin-right: 0.5rem; }
  </style>
</head>
<body>
  <h1>Smart Radio Search v1.3</h1>

  <input
    id="query"
    type="text"
    placeholder="Search for genre, location, etc."
    autofocus
  />
  <select id="sortBy">
    <option value="votes">Votes</option>
    <option value="clickcount">Clicks</option>
    <option value="bitrate">Bitrate</option>
  </select>
  <button onclick="search()">Search</button>
  <button onclick="toggleDark()">Toggle Dark Mode</button>

  <p id="aiResult"></p>
  <div id="results"></div>

  <script>
    async function search() {
      const resultsDiv  = document.getElementById("results");
      const aiResultDiv = document.getElementById("aiResult");
      const query       = document.getElementById("query").value.trim();
      const sortBy      = document.getElementById("sortBy").value || "votes";

      if (!query) return;

      let finalQuery  = query;
      let field       = "name";
      let refinedTags = "";

      resultsDiv.innerHTML  = "<p class='loading'>Thinking…</p>";
      aiResultDiv.innerHTML = "";

      // 1) AI-assisted tag refinement
      try {
        const aiRes  = await fetch(
          "https://simple-naomi-joewilcom-71ae2211.koyeb.app/ai-query",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query })
          }
        );
        const aiJson = await aiRes.json();
        if (aiJson.tags) {
          refinedTags = aiJson.tags.trim();
          finalQuery  = refinedTags;
          field       = "tag";
        }
      } catch (err) {
        console.warn("AI query failed:", err);
      }

      if (refinedTags && refinedTags !== query) {
        aiResultDiv.innerHTML =
          `Showing results for: <strong>${refinedTags}</strong>`;
      }

      // 2) Call /search
      try {
        const res = await fetch(
          "https://simple-naomi-joewilcom-71ae2211.koyeb.app/search",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              query:       finalQuery,
              filter_dead: true,
              sort_by:     sortBy,
              field
            })
          }
        );
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const stations = await res.json();
        renderStations(stations);
      } catch (err) {
        console.error("Search fetch failed:", err);
        resultsDiv.innerHTML =
          "<p>Failed to fetch stations. Please try again later.</p>";
      }
    }

    async function loadTopStations() {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML =
        "<p class='loading'>Loading top stations…</p>";

      try {
        const res = await fetch(
          "https://simple-naomi-joewilcom-71ae2211.koyeb.app/search",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              top:         true,
              filter_dead: true,
              sort_by:     "clickcount"
            })
          }
        );
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const stations = await res.json();
        renderStations(stations);
      } catch (err) {
        console.error("Top station fetch failed:", err);
        resultsDiv.innerHTML =
          "<p>Failed to load top stations. Please try again later.</p>";
      }
    }

    function renderStations(stations) {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      if (!stations.length) {
        resultsDiv.innerHTML =
          "<p>No stations found. Try a broader search.</p>";
        return;
      }

      stations.forEach((st, i) => {
        const div = document.createElement("div");
        div.innerHTML = `
          <h3>#${i + 1} ${st.name}</h3>
          <p>${st.country || ""}</p>
          <audio controls src="${st.url_resolved}"></audio>
          <p>
            <strong>Bitrate:</strong> ${st.bitrate || "?"} kbps
            | <strong>Votes:</strong> ${st.votes || 0}
          </p>
        `;
        resultsDiv.appendChild(div);
      });
    }

    function toggleDark() {
      const body = document.body;
      const dark = body.style.backgroundColor === "black";
      body.style.backgroundColor = dark ? "#B7B7B7" : "black";
      body.style.color           = dark ? "black" : "white";
    }

    window.addEventListener("DOMContentLoaded", loadTopStations);
  </script>
</body>
</html>
